#!/bin/bash

declare COMBINED_PATTERN=""

usage () { echo "Usage: $0 [-b] [-z] [-f] [-o <output>]" 1>&2; exit 1; }

heading () {
	echo -e "\033[1m================== $1 ==================\033[0m"
}

subheading () {
	echo -e "\033[1m------------------ $1 ------------------\033[0m"
}

result () {
	echo -e "\n\033[1;4m$1\033[0m"
}

declare -A SHELL_HISTFILE_DEFAULT_MAPPING=(
	[bash]="$HOME/.bash_history"
	[zsh]="$HOME/.histfile"
	[ksh]="$HOME/.sh_history"
	[fish]="$HOME/.local/share/fish/fish_history"
)

gethistfile () (
	set -e
	if [[ $1 == "bash" ]]; then
		HISTPATH=$(/bin/bash --rcfile <(echo 'echo "$HISTFILE"; exit') || echo ${SHELL_HISTFILE_DEFAULT_MAPPING[bash]})
	elif [[ $1 == "zsh" ]]; then
		HISTPATH=$(/bin/zsh -ic 'echo "$HISTFILE"' || echo ${SHELL_HISTFILE_DEFAULT_MAPPING[zsh]})
	elif [[ $1 == "ksh" ]]; then
		HISTPATH=$(/bin/ksh -ic 'echo "$HISTFILE"' || echo ${SHELL_HISTFILE_DEFAULT_MAPPING[ksh]})
	elif [[ $1 == "fish" ]]; then
		FISH_ID=$(/bin/fish -ic 'echo "$FISH_HISTFILE"')
		HISTPATH=$(find "$HOME/.local/share/fish/${FISH_ID}_history*" || echo ${SHELL_HISTFILE_DEFAULT_MAPPING[fish]})
	else
		heading "Encountered error"
		result "Unknown shell type $1"
		exit 1
	fi
	echo $HISTPATH
)

archive () {
	ACTIVE_SHELL=$1

	heading "Archiving for $ACTIVE_SHELL shell"

	subheading "Finding history file for $ACTIVE_SHELL"

	HISTFILE=$(gethistfile $ACTIVE_SHELL)
	DEFAULT_HISTFILE=${SHELL_HISFILE_DEFAULT_MAPPING[$ACTIVE_SHELL]}

	if [[ ! -f $HISTFILE ]]; then
		result "Coudn't find history file at $HISTFILE. Defaulting to $DEFAULT_HISTFILE"
		HISTFILE=$DEFAULT_HISTFILE
	fi

	subheading "Removing ignore patterns"

	echo -e "\033[1mPatterns:\033[0m"
	printf '%s\n' "${IGNORE_PATTERNS[@]}"

	OUTPUT_FILE="$OUTPUT_PATH/$(basename $HISTFILE)"

	sed -r "/$COMBINED_PATTERN/d" $HISTFILE > "$OUTPUT_FILE"

	result "Ignored patterns removed"

	subheading "Removing duplicate entries"

	/usr/bin/cat -n "$HISTFILE" | sort -k2 -k1n  | uniq -f1 | sort -nk1,1 | cut -f2- > "$OUTPUT_FILE"

	result "Duplicate entries removed"
}

declare -a SHELLS=()
declare ALL_SHELLS=true

while getopts "bkzfo:" arg; do
	case $arg in
		b)
			SHELLS+=("bash")
			ALL_SHELLS=false
			;;
		k)
			SHELLS+=("ksh")
			ALL_SHELLS=false
			;;
		z)
			SHELLS+=("zsh")
			ALL_SHELLS=false
			;;
		f)
			SHELLS+=("fish")
			ALL_SHELLS=false
			;;
		o)
			OUTPUT_PATH=$(readlink -f $OPTARG)
			;;
		*)
			usage
			;;
	esac
done

echo $([ "$ALL_SHELLS" == true ])

if [ "$ALL_SHELLS" == true ]; then
	if [[ -f $(gethistfile "bash") ]]; then
		SHELLS+=("bash")
	elif [[ -f $(gethistfile "ksh") ]]; then
		SHELLS+=("ksh")
	elif [[ -f $(gethistfile "zsh") ]]; then
		SHELLS+=("zsh")
	elif [[ -f $(gethistfile "fish") ]]; then
		SHELLS+=("fish")
	fi
fi

if [ -z "$OUTPUT_PATH" ]; then
	STDOUT=true
fi

heading "History Archival"

if [[ -z $STDOUT ]]; then
	result "Chosen output"
	echo "$OUTPUT_PATH"
else
	result "Piping to stdout"
fi

IGNORE_PATTERNS=(
	'--help'                            # help options
	'^l(|s|l)$'                         # ls aliases
	'^cd(|\s*)(|\.|\.\.|-|\/)$'         # cd aliases
	'^s(|tart)x$'                       # startx aliases
	'^(|sudo\s*)pacman\s*-S(|yy)(|u)$'  # pacman -Syyu (without args)
	'^reboot$'                          # reboot commands
	'^xprop$'                           # xprop commands
	'^c(ls|lear)$'                      # clear screen commands
)
printf -v COMBINED_PATTERN '(%s)|' "${IGNORE_PATTERNS[@]}"
COMBINED_PATTERN=${COMBINED_PATTERN:0:-1}

for shell in ${SHELLS[@]}; do
	archive $shell
done

heading "Wrapping up"

result "Job done. Find your archive at $OUTPUT_PATH"
